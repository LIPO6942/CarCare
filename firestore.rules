
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Vehicles can only be accessed by their owner
    match /vehicles/{vehicleId} {
      allow read, create, update, delete: if isOwner(resource.data.userId);
    }

    // Sub-collections data can only be accessed if the user owns the parent vehicle.
    match /repairs/{repairId} {
      allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/vehicles/$(request.resource.data.vehicleId)).data.userId);
    }

    match /maintenance/{maintenanceId} {
      allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/vehicles/$(request.resource.data.vehicleId)).data.userId);
    }

    match /fuelLogs/{fuelLogId} {
      allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/vehicles/$(request.resource.data.vehicleId)).data.userId);
    }
    
    match /aiDiagnostics/{diagId} {
      allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/vehicles/$(request.resource.data.vehicleId)).data.userId);
    }

    // FCM Tokens can be created by any authenticated user for themselves,
    // but cannot be read or modified by others.
    match /fcmTokens/{tokenId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if false; // Disallow reading/modifying tokens for security
    }
  }
}
